<?php
/**
 *
 * Cadastro de vinculo serс feito por dois usuarios diferetnes.
 * Administraчуo ou Guiche. Com suas particularidades.
 *
 * A seguir o cadastro de vinculo pelo usuario administrador.
 *
 * 1- Verificaчуo de Id de usuario de base externa.
 * Esse usuario existe na base local? Captura-se o Id da base local para: $idUsuarioBaseLocal;
 * Nуo existe na base local: Cadastra-se e captura-se o id da base local para: $idUsuarioBaseLocal;
 *
 *
 *
 *
 * 2- Verificaчуo de cartуo.
 *
 *
 *
 *
 * 3 - Verificaчуo de vinculos do usuario.
 *
 *
 *
 * 4 - Verificaчуo de vinculos do Cartуo.
 *
 *
 *
 * 5 - Adicionar vinculo.
 *
 *
 *
 */
class VinculoDAO extends DAO {
	
	
	public function adicionaVinculo($idUsuarioBaseExterna, $numeroCartao, $dataDeValidade) {
		$idBaseLocal = $this->verificarUsuario($idUsuarioBaseExterna);
		echo 'Base Local'.$idBaseLocal;
		$numeroCartao = intval ( $numeroCartao);
		$result = $this->getConexao()->query("SELECT * FROM cartao WHERE cart_numero = $numeroCartao");
		foreach ($result as $linha){
			echo 'Cartao Existe na base local';
			return;
		}
		echo 'Cartao Nao existe na base local';
		
	}
	/**
	 * 
	 * @param int $idBaseExterna
	 * @return int
	 */
	public function verificarUsuario($idBaseExterna){
		$idBaseExterna = intval ( $idBaseExterna );
		$result = $this->getConexao()->query("SELECT id_base_externa, usua_id FROM usuario WHERE id_base_externa = $idBaseExterna");
		foreach ($result as $linha){
			return $linha['usua_id'];
		}
		//Vamos pegar da base exter a ecopiar para a base local. 
		//Se Nem existir na base externa, щ o usuario frescando. Preciso dar nem resposta pra ele. Aborto tudo logo.
		$daoSistemasComum = new DAO(null, DAO::TIPO_PG_SISTEMAS_COMUM);
		$result2 = 	$daoSistemasComum->getConexao()->query("SELECT * FROM vw_usuarios_autenticacao_catraca WHERE id_usuario = $idBaseExterna");
		foreach($result2 as $linha){
			//Faчamos um insert aqui. 
			//Apos esse insert iremos pegar o id inserido na base e retornalo. 
			$nivel = Sessao::NIVEL_COMUM;
			$nome = $linha['nome'];
			$email = $linha['email'];
			$login = $linha['login'];
			$idBaseExterna = $linha['id_usuario'];
			if($this->getConexao()->exec("INSERT into usuario(usua_login,usua_senha, usua_nome,usua_email, usua_nivel, id_base_externa)
					VALUES				('$login', '$senha', '$nome','$email', $nivel, $idBaseExterna)")){
				return $this->getConexao()->lastInsertId();
				
			}
		}
		return 0;	
		//Retorna 0, deu nada certo. Essa parada acaba aqui. 
		
		
	}
	
	
}

?>